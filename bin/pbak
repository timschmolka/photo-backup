#!/bin/bash
set -euo pipefail

PBAK_VERSION="0.1.0"

# Follows symlinks so lib/ is found when installed via Homebrew or `make install`
_pbak_resolve() {
    local path="$1"
    while [[ -L "$path" ]]; do
        local dir
        dir="$(cd "$(dirname "$path")" && pwd)"
        path="$(readlink "$path")"
        [[ "$path" != /* ]] && path="${dir}/${path}"
    done
    echo "$(cd "$(dirname "$path")" && pwd)"
}

PBAK_BIN="$(_pbak_resolve "$0")"
PBAK_ROOT="$(cd "${PBAK_BIN}/.." && pwd)"
PBAK_LIB="${PBAK_ROOT}/lib/pbak"

source "${PBAK_LIB}/utils.sh"
source "${PBAK_LIB}/ui.sh"
source "${PBAK_LIB}/config.sh"
source "${PBAK_LIB}/hash.sh"
source "${PBAK_LIB}/dump.sh"
source "${PBAK_LIB}/upload.sh"

DRY_RUN=0
VERBOSE=0
export DRY_RUN VERBOSE

pbak_usage() {
    cat <<EOF
${UI_BOLD}pbak${UI_RESET} v${PBAK_VERSION} â€” Photo backup utility

${UI_BOLD}Usage:${UI_RESET}
  pbak <command> [flags]

${UI_BOLD}Commands:${UI_RESET}
  setup       Configure Immich server, volumes, and file extensions
  dump        Copy photos from SD card to SSD (with deduplication)
  upload      Upload photos from SSD to Immich via immich-go
  status      Show backup status and configuration summary
  rehash      Rebuild the hash database from existing SSD files

${UI_BOLD}Global Flags:${UI_RESET}
  --dry-run   Show what would be done without making changes
  --verbose   Enable verbose output
  --version   Print version and exit
  -h, --help  Show this help

${UI_BOLD}Examples:${UI_RESET}
  pbak setup                  # First-time configuration
  pbak dump                   # Interactive SD -> SSD backup
  pbak dump --dry-run         # Preview what would be copied
  pbak upload --all           # Upload all pending folders to Immich
  pbak status                 # Check backup state
  pbak rehash                 # Rebuild hash DB from SSD contents
EOF
}

_pbak_cleanup() {
    ui_spinner_stop 2>/dev/null || true
}
trap _pbak_cleanup EXIT
trap 'ui_error "Interrupted."; exit 130' INT TERM

while [[ $# -gt 0 ]]; do
    case "$1" in
        --dry-run)  DRY_RUN=1; shift ;;
        --verbose)  VERBOSE=1; shift ;;
        --version)  echo "pbak ${PBAK_VERSION}"; exit 0 ;;
        -h|--help)  pbak_usage; exit 0 ;;
        -*)         ui_error "Unknown flag: $1"; echo; pbak_usage; exit 1 ;;
        *)          break ;;
    esac
done

SUBCOMMAND="${1:-}"
shift || true

if [[ -z "$SUBCOMMAND" ]]; then
    pbak_usage
    exit 0
fi

case "$SUBCOMMAND" in
    setup)   pbak_setup "$@" ;;
    dump)    pbak_dump "$@" ;;
    upload)  pbak_upload "$@" ;;
    status)  pbak_status "$@" ;;
    rehash)  pbak_rehash "$@" ;;
    help)    pbak_usage ;;
    *)       ui_error "Unknown command: ${SUBCOMMAND}"; echo; pbak_usage; exit 1 ;;
esac
